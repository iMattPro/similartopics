{% if S_DYNAMIC_SIMILAR_TOPICS and S_POST_ACTION and not S_EDIT_POST %}
{% INCLUDECSS '@vse_similartopics/similar_topics_ajax.css' %}
<script>
(function() {
	let searchTimeout;
	const dropdown = document.getElementById('similar-topics-dropdown');
	const subjectField = document.getElementById('subject');
	const listContainer = document.getElementById('similar-topics-list');

	if (!subjectField || !dropdown) return;

	// Disable browser autocomplete to prevent interference
	subjectField.setAttribute('autocomplete', 'off');

	function positionDropdown() {
		const rect = subjectField.getBoundingClientRect();
		dropdown.style.left = rect.left + 'px';
		dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
		dropdown.style.width = rect.width + 'px';
	}

	function hideDropdown() {
		dropdown.style.display = 'none';
	}

	function showDropdown() {
		positionDropdown();
		dropdown.style.display = 'block';
	}

	function searchSimilarTopics(query) {
		if (query.length < 3) {
			hideDropdown();
			return;
		}

		const xhr = new XMLHttpRequest();
		xhr.open('GET', '{{ U_PST_AJAX_SEARCH|e('js') }}?q=' + encodeURIComponent(query) + '&f={{ FORUM_ID|e('js') }}');
		xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

		xhr.onreadystatechange = () => {
			if (xhr.readyState === 4 && xhr.status === 200) {
				try {
					const response = JSON.parse(xhr.responseText);
					displayResults(response.topics);
				} catch (e) {
					hideDropdown();
				}
			}
		};

		xhr.send();
	}

	function displayResults(topics) {
		if (!topics || topics.length === 0) {
			hideDropdown();
			return;
		}

		listContainer.innerHTML = '';

		topics.forEach(topic => {
			const item = document.createElement('div');
			item.className = 'similar-topic-item';

			const link = document.createElement('a');
			link.href = topic.url;
			link.className = 'similar-topic-title';
			link.textContent = topic.title;
			link.target = '_blank';

			item.appendChild(link);
			listContainer.appendChild(item);
		});

		showDropdown();
	}

	subjectField.addEventListener('input', () => {
		clearTimeout(searchTimeout);
		const query = subjectField.value.trim();

		searchTimeout = setTimeout(() => {
			searchSimilarTopics(query);
		}, 300);
	});

	subjectField.addEventListener('blur', () => {
		setTimeout(hideDropdown, 200);
	});

	document.addEventListener('click', (e) => {
		if (!dropdown.contains(e.target) && e.target !== subjectField) {
			hideDropdown();
		}
	});
})();
</script>
{% endif %}
